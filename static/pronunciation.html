<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pronunciation Exercise</title>
</head>
<body>
  <h1>üó£Ô∏è Pronunciation Practice</h1>

  <button onclick="getWord()">üîÑ Get New Word</button>
  <p id="wordDisplay"></p>

  <button onclick="startRecording()">üéôÔ∏è Start Recording</button>
  <button onclick="stopRecording()">‚èπÔ∏è Stop & Transcribe</button>
  <p id="transcription"></p>

  <button onclick="evaluatePronunciation()">‚úÖ Evaluate Pronunciation</button>
  <p id="score"></p>
  <p id="advice"></p>

  <button onclick="finalizeAttempt()">üì¶ Finalize Attempt</button>
  <p id="status" style="color: green;"></p>

  <script>
  console.log("JS loaded");
  const USER_ID = "af7c51c4-f34b-4cb5-bd8f-3475b1491f10";

  let wordId = "";
  let germanWord = "";
  let recognizedText = "";
  let score = 0;
  let mediaRecorder;
  let audioChunks = [];

  window.getWord = async function () {
    const res = await fetch("/pronunciation/word");
    const data = await res.json();
    wordId = data.word_id;
    germanWord = data.german;
    document.getElementById("wordDisplay").innerText = `üìù Word: ${germanWord} (${data.english})`;
  };

  window.startRecording = async function () {
    document.getElementById("status").innerText = "üéôÔ∏è Recording...";
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];

    mediaRecorder.ondataavailable = event => {
      audioChunks.push(event.data);
    };

    mediaRecorder.start();
  };

    window.stopRecording = async function () {
      document.getElementById("status").innerText = "‚è≥ Transcribing...";
      mediaRecorder.stop();

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("file", audioBlob, "recording.webm");

        try {
          const res = await fetch("/pronunciation/record", {
            method: "POST",
            body: formData
          });

          if (!res.ok) {
            throw new Error(`STT failed with status ${res.status}`);
          }

          const data = await res.json();
          recognizedText = data.recognized_text;
          document.getElementById("transcription").innerText = `üó£Ô∏è You said: ${recognizedText}`;
          console.log("üéß Transcription result:", recognizedText);
        } catch (err) {
          console.error("‚ùå STT failed:", err);
          document.getElementById("transcription").innerText = "‚ùå STT failed";
        }
        const audioURL = URL.createObjectURL(audioBlob);
        const audioPlayer = new Audio(audioURL);
        audioPlayer.controls = true;
        document.getElementById("transcription").appendChild(audioPlayer);
      };
    };

  window.evaluatePronunciation = async function () {
    console.log("üì§ Evaluate button clicked");

    const payload = {
      word_id: wordId,
      user_id: USER_ID,
      target_word: germanWord,
      recognized_text: recognizedText
    };

    console.log("üì§ Sending to /evaluate:", payload);

    try {
      const res = await fetch("/pronunciation/evaluate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        throw new Error(`Server responded with ${res.status}`);
      }

      const data = await res.json();
      console.log("‚úÖ Evaluation response:", data);

      score = data.score;
      document.getElementById("score").innerText = `üéØ Score: ${score}%`;
      document.getElementById("advice").innerText = `üí° Advice: ${data.advice}`;
    } catch (err) {
      console.error("‚ùå Evaluation failed:", err);
      document.getElementById("score").innerText = "‚ùå Evaluation failed";
      document.getElementById("advice").innerText = "";
    }
  };

  window.finalizeAttempt = async function () {
    const res = await fetch("/pronunciation/finalize", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        word_id: wordId,
        user_id: USER_ID,
        final_text: recognizedText,
        score: score
      })
    });

    const data = await res.json();
    document.getElementById("status").innerText = `‚úÖ Final attempt saved`;
  };
</script>
</body>
</html>